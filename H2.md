# H2 Infra-as-code

### Käyttöympäristö

MacBookPro 13-tuumainen 2020 <br />
MacOS Sequoia Versio 15.0.1 <br />
Prosessori: 1,4 GHz Neliytiminen Intel Core i5 <br />
Näytönohjain: Intel Iris Plus Graphics 645, 1536 Mt <br />
Muisti: 8 Gt 2133 MHz LPDDR3 <br />

Oracle VirtualBox Version 7.1.4 r165100 (Qt6.5.3) <br />
Debian GNU/Linux 12 Bookworm (64-bit) <br />
4000 MB RAM <br />
60 GB Levytilaa <br />

## x) Lue ja tiivistä 
Aloitin työn 4.11.2024 klo 16.30 ja lopetin klo 19.40.


### Two Machine Virtual Network With Debian 11 Bullseye and Vagrant (Karvinen, T. 2021)

-  Vagrantin asennus
-  Luo hakemisto projektille ja tallenna Vagrantfile sinne
-  Määritä kaksi isäntää Vagrantfile-tiedostossa ja käynnistä virtuaalikoneet
-  Yhdistä koneisiin SSH-yhteydellä
-  Tuhoa virtuaalikoneet ja käynnistä tyhjät koneet
  
### Karvinen 2018: Salt Quickstart – Salt Stack Master and Slave on Ubuntu Linux 

Tämä Salt Quickstart -artikkeli on pikaopas siitä, miten Salt master ja Salt Minion asennetaan. Artikkelissa on paljon eri komentoja, joita kokeilla:

- Masterin asennus
- Minionin asennus
- Minionin avaimen vahvistus masterilla
- Yhteyden testaaminen

Lisäksi artikkelissa on suuri kasa muita kokeiltavia komentoja.

### Karvinen 2014: Hello Salt Infra-as-Code 

- Saltin asennus
- Luo kansiolle moduuli
- Luo init.sls-tiedosto hello-kansioon ja lisää siihen Salt-komento tiedoston luomiseksi
- Käynnistä moduuli
- Idempotenssi: Toistuvat ajot eivät tee uusia muutoksia, jos tila on jo oikea
  
### Karvinen 2023: Salt Vagrant - automatically provision one master and two slaves

- Järjestelmätilojen autimatisointi Saltilla.

### Salt contributors: Salt overview, kohdat

- YAML-tiedot esitetään avain-arvo (key: value) -pareina.
- Käytä kaksoispistettä ja välilyöntiä (: ) erottamaan avain ja arvo.
- Kaikki avaimet ovat merkkikohtaisia (case-sensitive).
- Välilehdet eivät ole sallittuja, käytä vain välilyöntejä.
- Kommentit alkavat merkillä #.

Kolme peruselementtiä YAMLissa:

- Scalar: Avain-arvo-parit, joissa arvo voi olla numero, merkkijono tai looginen arvo.
- Lists: Avain, jota seuraa lista arvoista. Jokainen arvo aloitetaan kahdella välilyönnillä ja yhdysmerkillä.
- Dictionary: Avain-arvo-parien ja listojen kokoelma.

YAML perustuu lohkorakenteisiin, joissa sisennys määrittää kontekstin.

- Sisennys: Kaikki ominaisuudet ja listat täytyy sisentää yhdellä tai useammalla välilyönnillä, ja kaksi välilyöntiä on yleinen käytäntö.
- Kokoelmat: Listojen ja sanakirjojen jokainen alkio merkitään viivalla ja välilyönnillä ("-").


## a) Hello Vagrant!
Aloitin osion 5.11.2024 klo 9.35 ja lopetin 5.11.2024 klo 17.30.

Meinasin jostain syystä ensin ladata Vagrantin Virtuaalikoneelle, jolloin updatea tehdessä törmäsin saltstack ongelmaan, ja jäin siihen jumiin koko päiväksi. 

Jostain syystä updatessa herjaa saltstack ongelmaa, jota ei aiemmin ole ollut. Käy ilmi, että saltstackin palvelin on alhaalla. 

<img width="672" alt="Näyttökuva 2024-11-05 kello 10 27 34" src="https://github.com/user-attachments/assets/c0b775da-21a3-4361-be39-d24e03b3d4af">

Aloin googlailemaan ja tutkimaan lähemmin asiaa, sillä saltin palvelimet ovat käsittääkseni vain lyhyitä aikoja alhaalla. Löysin Salt projektin blogista lisätietoja, eli Salt Project on ilmoittanut, että bootstrap.saltproject.io -alaosoitteet poistuvat käytöstä lokakuun 2024 loppuun mennessä. Tämä johtuu DNS-siirroista ja muista muutoksista, jotka vaikuttavat salt-bootstrap -skriptin lataamiseen. Tämän seurauksena nykyinen tapa ladata salt-bootstrap-skripti (esim. komento curl -L https://bootstrap.saltproject.io) ei enää toimi.

Tässä vaiheessa mun kone oli jotenkin aivan kiisselissä, joten aloitin koko homman alusta.

Eli seuraavalla komennolla latasin saltin julkisen GPG-avaimen ja tallensin sen tiedostoon /etc/apt/keyrings/salt-archive-keyring-2023.pgp:

    $ curl -fsSL https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public | sudo tee /etc/apt/keyrings/salt-archive-keyring-2023.pgp


<img width="626" alt="Näyttökuva 2024-11-05 kello 14 46 40" src="https://github.com/user-attachments/assets/d112b71d-0cde-439f-a261-cf22ba0c0548">


Sitten loin uuden APT-lähteen salt projektin pakettivarastolle komennolla:


    echo "deb [signed-by=/etc/apt/keyrings/salt-archive-keyring-2023.pgp arch=amd64] https://packages.broadcom.com/artifactory/saltproject-deb/ stable main" | sudo tee /etc/apt/sources.list.d/salt.nno


<img width="611" alt="Näyttökuva 2024-11-05 kello 14 35 13" src="https://github.com/user-attachments/assets/6ba77b3f-07ac-4420-8ca8-36d4bc86bf0b">

Sitten komennot

    $ sudo apt-get update
    $ sudo apt-get install salt-minion


<img width="626" alt="Näyttökuva 2024-11-05 kello 14 37 06" src="https://github.com/user-attachments/assets/7c4132f2-3b60-4d84-8919-3314e0275ae6">


Sitten tsekkasin IP:n komennolla: 

     $ hostname -I   

Ja sitten menin uudelleen muokkaamaan minionin konfiguraatioita (Masterin nimeksi 10.0.2.15 ja id: localhost) komennolla:

    $ sudoedit /etc/salt/minion0

<img width="626" alt="Näyttökuva 2024-11-05 kello 15 00 57" src="https://github.com/user-attachments/assets/d6819e84-2989-4b11-83da-510f572a3d57">


Sitten käynnisti salt minionin komennolla: 

    $ sudo systemctl restart salt-minion.service

Nyt toimii taas saltstacki, mutta tehtävää en ole saanut edes aloitettua. 

Eli, lataan macille tarkoitetun Vagrantin (Intel):

<img width="351" alt="Näyttökuva 2024-11-05 kello 16 58 25" src="https://github.com/user-attachments/assets/94e501e5-b474-4dde-a803-88b16b33c65e">

Macissa oli valmiina jo virtuaalikoneen asennus. 

Seuraavaksi menen terminaaliin. Täällä näen Vagrantin version komennolla 

    vagrant --version

<img width="581" alt="Näyttökuva 2024-11-05 kello 17 17 47" src="https://github.com/user-attachments/assets/9778663e-cbb8-4042-ac38-f371b0aca0ac">

VirtualBoxin version sain komennolla (VirtualBox keskustelufoorumi 2015):

    VBoxManage --version

<img width="351" alt="Näyttökuva 2024-11-05 kello 17 48 44" src="https://github.com/user-attachments/assets/373b67d8-5958-4563-8f16-5cfa0d71be58">

(Lähteet: Karvinen 2018, Karvinen 2014, Salt contributors 2021-2024, Salt projektin blogi 2024, VirtualBox keskustelufoorumi 2015).


## b) Linux Vagrant. Tee Vagrantilla uusi Linux-virtuaalikone.
Aloitin osion 5.11.2024 klo 17.30 ja lopetin 5.11.2024 klo 18.25.

En rehellisesti löytänyt mistään mitään tietoa macin komennoista, ja googlaaminen ei tuottanut tulosta, joten pyysin apua chatgpt:ltä.

Ensin loin uuden hakemiston projektille ja tallensin tämän Vagrantfilen siihen

    $ mkdir twohost && cd twohost

<img width="413" alt="Näyttökuva 2024-11-05 kello 18 02 13" src="https://github.com/user-attachments/assets/60354ccd-3553-48fe-a8d7-8432449f2ac5">

Sitten loin ja muokkasin itse tiedostoa nanossa: 

    $ nano Vagrantfile

<img width="583" alt="Näyttökuva 2024-11-05 kello 18 05 13" src="https://github.com/user-attachments/assets/24b5fd7f-3197-42d8-9379-56e0cbefc68a">

Käynnistin virtuaalikoneen komennolla:

    $ vagrant up
    
<img width="583" alt="Näyttökuva 2024-11-05 kello 18 07 56" src="https://github.com/user-attachments/assets/6148fbd6-4fdd-4190-87b2-894d900eddba">

<img width="583" alt="Näyttökuva 2024-11-05 kello 18 09 50" src="https://github.com/user-attachments/assets/3516a8a0-bd33-4f32-a0b0-5259efc41748">

Vielä testi, että SSH:lla pystyy kirjautumaan: 

    $ vagrant ssh t001

<img width="583" alt="Näyttökuva 2024-11-05 kello 18 22 37" src="https://github.com/user-attachments/assets/60ce5aa1-8738-403a-8595-4608988836d4">

Ja vielä pois komennolla: 

    $ exit
    
<img width="258" alt="Näyttökuva 2024-11-05 kello 18 27 29" src="https://github.com/user-attachments/assets/2fa64739-fc6f-4865-8647-f38c754cc725">

Nyt on Linux-virtuaalikone pystyssä ja sillä kaksi isäntää!

Lähteet: Karvinen 2021, ChatGPT (komentolista), Valkamo 2022.


## c) Kaksin kaunihimpi. Tee kahden Linux-tietokoneen verkko Vagrantilla. Osoita, että koneet voivat pingata toisiaan.
Aloitin osion 5.11.2024 klo 18.25 ja lopetin 5.11.2024 klo 18.40. 

Olen jo luonut kakasi virtuaalikonetta, joten kokeilen heti pingausta!

Menin takaisin koneelle 001 koemnnolla 

    $ vagrant ssh t001

Ja pingasin

    $ ping -c 1 192.168.88.102

Toimii!

<img width="456" alt="Näyttökuva 2024-11-05 kello 18 34 33" src="https://github.com/user-attachments/assets/ce82542c-71de-4e50-8ee9-4012e950c2fd">

Sitten menin ulos komennolla 

    $ exit

Menin koneelle 002 koemnnolla 

    $ vagrant ssh t002

Ja pingasin

    $ ping -c 1 192.168.88.101

Sekin toimii! Sitten menin jälleen ulos komennolla 

    $ exit

<img width="460" alt="Näyttökuva 2024-11-05 kello 18 38 42" src="https://github.com/user-attachments/assets/179662e6-4c3b-4d28-9ab8-6b99d74595c9">

Lähteet: Karvinen 2021, ChatGPT (komentolista), Valkamo 2022.

## d) Herra-orja verkossa. Demonstroi Salt herra-orja arkkitehtuurin toimintaa kahden Linux-koneen verkossa, jonka teit Vagrantilla. Asenna toiselle koneelle salt-master, toiselle salt-minion. Laita orjan /etc/salt/minion -tiedostoon masterin osoite. Hyväksy avain ja osoita, että herra voi komentaa orjakonetta.
Aloitin 5.11.2024 klo 18.40 ja lopetin klo 

Jotta saan ladattua saltin uudelle virtuaalikoneelleni, minun pitää ladata curl ja jotta saan curlin, minun tulee ladata hombrew. Nämä kaikki tapahtuu komennoilla: 

    $ /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    $ brew install curl

Tsekkaan vielä, että toimivat komennoilla:

    $ brew --version
    $ curl --version

<img width="566" alt="Näyttökuva 2024-11-05 kello 19 11 04" src="https://github.com/user-attachments/assets/4555087a-7a12-43c0-84d2-4bc14ae42624">

Sitten yritän ladata saltin. Niin kuin tuossa jo aiemmin totesin, saltin palvelin on muuttunut, joten pitää kaivaa tämän päivän aiemmat muistiinpanot esiin. 

Eli seuraavalla komennolla latasin saltin julkisen GPG-avaimen ja tallensin sen tiedostoon /etc/apt/keyrings/salt-archive-keyring-2023.pgp:

    $ curl -fsSL https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public | sudo tee /etc/apt/keyrings/salt-archive-keyring-2023.pgp

<img width="566" alt="Näyttökuva 2024-11-05 kello 19 17 13" src="https://github.com/user-attachments/assets/4e28bb7c-f430-4b9b-a001-d0c05ffcebfe">

Sitten loin uuden APT-lähteen salt projektin pakettivarastolle komennolla:

    echo "deb [signed-by=/etc/apt/keyrings/salt-archive-keyring-2023.pgp arch=amd64] https://packages.broadcom.com/artifactory/saltproject-deb/ stable main" | sudo tee /etc/apt/sources.list.d/salt.nno

Mutta tässäå vaiheessa tuli tietysti error, koska unohdin, että olen lataamassa tätä macille. 

NOrmaalisti voisi käyttää brewta apuna, mutta sekään ei toimi, vaikka vielä päivitin sen. Nyt tulikin uusi tenkkapoo, sillä Salt projekti Blogissa (2024) sanotaan, että bootstrap scriptit tulee jatkossa hakea suoraan Githubin reposta. Eli lähden nyt sitä kokeilemaan Salt Projekt Blogin avustuksella. 

    $ curl -L -O https://bootstrap.saltproject.io/bootstrap-salt.sh/py3/macos/minor/3007.1/salt-3007.1-py3-x86_64.pkg

????????
    
Lähteet: Karvinen 2023, Karvinen 2023, Salt projektin blogi 2024. 


## e) Hei infrakoodi! Kokeile paikallisesti (esim 'sudo salt-call --local') infraa koodina. Kirjota sls-tiedosto, joka tekee esimerkkitiedoston /tmp/ -kansioon.

## f) Aja esimerkki sls-tiedostosi verkon yli orjalla.

## g) Tee sls-tiedosto, joka käyttää vähintään kahta eri tilafunktiota näistä: package, file, service, user. Tarkista eri ohjelmalla, että lopputulos on oikea. Osoita useammalla ajolla, että sls-tiedostosi on idempotentti.

## h) Top file. Automatisoi vähintään kahden tilan / modulin ajaminen. Esim. komento 'sudo salt "*" state.apply' tai 'sudo salt-call --local state.apply' ajaa modulit "hello" ja "apache".

## i) Vapaaehtoinen, haastavahko tässä vaiheessa: Asenna ja konfiguroi Apache. Sen tulee näyttää palvelimen etusivulla weppisivua. Weppisivun tulee olla muokattavissa käyttäjän oikeuksin, ilman sudoa.


### Lähteet

-  ChatGPT 2024 (komentolista macille. 
-  Karvinen, T. 2024. Etäluennot. 
-  Karvinen, T. 2023. Salt Vagrant - automatically provision one master and two slaves. Luettavissa: https://terokarvinen.com/2023/salt-vagrant/#infra-as-code---your-wishes-as-a-text-file. Luettu: 4.11.2024.
-  Karvinen, T. 2021. Two Machine Virtual Network With Debian 11 Bullseye and Vagrant. Luettavissa: https://terokarvinen.com/2021/two-machine-virtual-network-with-debian-11-bullseye-and-vagrant/. Luettu: 4.11.2024.
-  Karvinen, T. 2018. Salt Quickstart – Salt Stack Master and Slave on Ubuntu Linux. Luettavissa: https://terokarvinen.com/2018/salt-quickstart-salt-stack-master-and-slave-on-ubuntu-linux/?fromSearch=salt%20quickstart%20salt%20stack%20master%20and%20slave%20on%20ubuntu%20linux. Viitattu: 4.11.2024
-  Karvinen, T. 2014. Hello Salt Infra-as-Code. Luettavissa: https://terokarvinen.com/2024/hello-salt-infra-as-code/. Luettu: 4.11.2024
-  Salt contributors 2021-2024. Salt overview. Luettavissa: https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#rules-of-yaml. Luettu: 4.11.2024.
-  Salt projektin blogi 2024. Luettavissa: https://saltproject.io/blog/salt-project-package-repo-migration-and-guidance/. Luettu: 5.11.2024.
-  Valkama, T. 2022. Create Virtual Machines with Vagrant. Luettavissa: https://tuomasvalkamo.com/CMS-course/week-6/. Luettu: 5.11.2024.
-  VirtualBox keskustelufoorumi 2015. Luettavissa: https://forums.virtualbox.org/viewtopic.php?t=93302#:~:text=From%20the%20Command%20Prompt%2FTerminal,VBoxManage%20%2Dversion
](https://forums.virtualbox.org/viewtopic.php?t=93302#:~:text=From%20the%20Command%20Prompt%2FTerminal,VBoxManage%20%2Dversion.Luettu: 5.11.2024. 
