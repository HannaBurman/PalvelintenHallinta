# H2 Infra-as-code

### Käyttöympäristö

MacBookPro 13-tuumainen 2020 <br />
MacOS Sequoia Versio 15.0.1 <br />
Prosessori: 1,4 GHz Neliytiminen Intel Core i5 <br />
Näytönohjain: Intel Iris Plus Graphics 645, 1536 Mt <br />
Muisti: 8 Gt 2133 MHz LPDDR3 <br />

Oracle VirtualBox Version 7.1.4 r165100 (Qt6.5.3) <br />
Debian GNU/Linux 12 Bookworm (64-bit) <br />
4000 MB RAM <br />
60 GB Levytilaa <br />

## x) Lue ja tiivistä 
Aloitin työn 4.11.2024 klo 16.30 ja lopetin klo 19.40.


### Two Machine Virtual Network With Debian 11 Bullseye and Vagrant (Karvinen, T. 2021)

-  Vagrantin asennus
-  Luo hakemisto projektille ja tallenna Vagrantfile sinne
-  Määritä kaksi isäntää Vagrantfile-tiedostossa ja käynnistä virtuaalikoneet
-  Yhdistä koneisiin SSH-yhteydellä
-  Tuhoa virtuaalikoneet ja käynnistä tyhjät koneet
  
### Karvinen 2018: Salt Quickstart – Salt Stack Master and Slave on Ubuntu Linux 

Tämä Salt Quickstart -artikkeli on pikaopas siitä, miten Salt master ja Salt Minion asennetaan. Artikkelissa on paljon eri komentoja, joita kokeilla:

- Masterin asennus
- Minionin asennus
- Minionin avaimen vahvistus masterilla
- Yhteyden testaaminen

Lisäksi artikkelissa on suuri kasa muita kokeiltavia komentoja.

### Karvinen 2014: Hello Salt Infra-as-Code 

- Saltin asennus
- Luo kansiolle moduuli
- Luo init.sls-tiedosto hello-kansioon ja lisää siihen Salt-komento tiedoston luomiseksi
- Käynnistä moduuli
- Idempotenssi: Toistuvat ajot eivät tee uusia muutoksia, jos tila on jo oikea
  
### Karvinen 2023: Salt Vagrant - automatically provision one master and two slaves

- Järjestelmätilojen autimatisointi Saltilla.

### Salt contributors: Salt overview, kohdat

- YAML-tiedot esitetään avain-arvo (key: value) -pareina.
- Käytä kaksoispistettä ja välilyöntiä (: ) erottamaan avain ja arvo.
- Kaikki avaimet ovat merkkikohtaisia (case-sensitive).
- Välilehdet eivät ole sallittuja, käytä vain välilyöntejä.
- Kommentit alkavat merkillä #.

Kolme peruselementtiä YAMLissa:

- Scalar: Avain-arvo-parit, joissa arvo voi olla numero, merkkijono tai looginen arvo.
- Lists: Avain, jota seuraa lista arvoista. Jokainen arvo aloitetaan kahdella välilyönnillä ja yhdysmerkillä.
- Dictionary: Avain-arvo-parien ja listojen kokoelma.

YAML perustuu lohkorakenteisiin, joissa sisennys määrittää kontekstin.

- Sisennys: Kaikki ominaisuudet ja listat täytyy sisentää yhdellä tai useammalla välilyönnillä, ja kaksi välilyöntiä on yleinen käytäntö.
- Kokoelmat: Listojen ja sanakirjojen jokainen alkio merkitään viivalla ja välilyönnillä ("-").


## a) Hello Vagrant! (on jo asennettu)

Vagrantin versionumero näkyviin komennolla:

    vagrant --version

<img width="323" alt="Näyttökuva 2024-11-05 kello 9 04 47" src="https://github.com/user-attachments/assets/8137ee7e-f2d7-447a-9a05-9ad204369e72">



## b) Linux Vagrant. Tee Vagrantilla uusi Linux-virtuaalikone.
Aloitin osion 5.11.2024 klo 9.35 ja lopetin 5.11.2024 klo

Teen Vagrantilla uuden Linux -virtuaalikoneen komennolla: 

    sudo apt-get update
    sudo apt-get install vagrant virtualbox

Jostain syystä updatessa herjaa saltstack ongelmaa, jota ei aiemmin ole ollut. Käy ilmi, että saltstackin palvelin on alhaalla, joten jatkan myöhemmin. 

<img width="672" alt="Näyttökuva 2024-11-05 kello 10 27 34" src="https://github.com/user-attachments/assets/c0b775da-21a3-4361-be39-d24e03b3d4af">

Aloin googlailemaan ja tutkimaan lähemmin asiaa, sillä saltin palvelimet ovat käsittääkseni vain lyhyitä aikoja alhaalla. Löysin Salt projektin blogista lisätietoja, eli Salt Project on ilmoittanut, että bootstrap.saltproject.io -alaosoitteet poistuvat käytöstä lokakuun 2024 loppuun mennessä. Tämä johtuu DNS-siirroista ja muista muutoksista, jotka vaikuttavat salt-bootstrap -skriptin lataamiseen. Tämän seurauksena nykyinen tapa ladata salt-bootstrap-skripti (esim. komento curl -L https://bootstrap.saltproject.io) ei enää toimi.

Tässä vaiheessa mun kone oli jotenkin aivan kiisselissä, joten aloitin koko homman alusta.

Eli seuraavalla komennolla latasin saltin julkisen GPG-avaimen ja tallensin sen tiedostoon /etc/apt/keyrings/salt-archive-keyring-2023.pgp:

    curl -fsSL https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public | sudo tee /etc/apt/keyrings/salt-archive-keyring-2023.pgp


<img width="626" alt="Näyttökuva 2024-11-05 kello 14 46 40" src="https://github.com/user-attachments/assets/d112b71d-0cde-439f-a261-cf22ba0c0548">


Sitten loin uuden APT-lähteen salt projektin pakettivarastolle komennolla:


    echo "deb [signed-by=/etc/apt/keyrings/salt-archive-keyring-2023.pgp arch=amd64] https://packages.broadcom.com/artifactory/saltproject-deb/ stable main" | sudo tee /etc/apt/sources.list.d/salt.nno


<img width="611" alt="Näyttökuva 2024-11-05 kello 14 35 13" src="https://github.com/user-attachments/assets/6ba77b3f-07ac-4420-8ca8-36d4bc86bf0b">

Sitten komennot

    sudo apt-get update
    sudo apt-get install salt-minion


<img width="626" alt="Näyttökuva 2024-11-05 kello 14 37 06" src="https://github.com/user-attachments/assets/7c4132f2-3b60-4d84-8919-3314e0275ae6">


Sitten tsekkasin IP:n komennolla: 

     hostname -I   

Ja sitten menin uudelleen muokkaamaan minionin konfiguraatioita (Maasterin nimeksi 10.0.2.15 ja id: localhost) komennolla:

    $ sudoedit /etc/salt/minion0

kuva 15.01

Sitten käynnisti salt minionin komennolla: 

    $ sudo systemctl restart salt-minion.service

Ja aloitin kaiken alusta, eli 

    $ sudo apt-get update
    $ sudo apt-get install vagrant virtualbox



    
    
    













## c) Kaksin kaunihimpi. Tee kahden Linux-tietokoneen verkko Vagrantilla. Osoita, että koneet voivat pingata toisiaan.

## d) Herra-orja verkossa. Demonstroi Salt herra-orja arkkitehtuurin toimintaa kahden Linux-koneen verkossa, jonka teit Vagrantilla. Asenna toiselle koneelle salt-master, toiselle salt-minion. Laita orjan /etc/salt/minion -tiedostoon masterin osoite. Hyväksy avain ja osoita, että herra voi komentaa orjakonetta.

## e) Hei infrakoodi! Kokeile paikallisesti (esim 'sudo salt-call --local') infraa koodina. Kirjota sls-tiedosto, joka tekee esimerkkitiedoston /tmp/ -kansioon.

## f) Aja esimerkki sls-tiedostosi verkon yli orjalla.

## g) Tee sls-tiedosto, joka käyttää vähintään kahta eri tilafunktiota näistä: package, file, service, user. Tarkista eri ohjelmalla, että lopputulos on oikea. Osoita useammalla ajolla, että sls-tiedostosi on idempotentti.

## h) Top file. Automatisoi vähintään kahden tilan / modulin ajaminen. Esim. komento 'sudo salt "*" state.apply' tai 'sudo salt-call --local state.apply' ajaa modulit "hello" ja "apache".

## i) Vapaaehtoinen, haastavahko tässä vaiheessa: Asenna ja konfiguroi Apache. Sen tulee näyttää palvelimen etusivulla weppisivua. Weppisivun tulee olla muokattavissa käyttäjän oikeuksin, ilman sudoa.


### Lähteet

- Karvinen, T. 2024. Etäluennot. 
-  Karvinen, T. 2023. Salt Vagrant - automatically provision one master and two slaves. Luettavissa: https://terokarvinen.com/2023/salt-vagrant/#infra-as-code---your-wishes-as-a-text-file. Viitattu: 4.11.2024.
-  Karvinen, T. 2021. Two Machine Virtual Network With Debian 11 Bullseye and Vagrant. Luettavissa: https://terokarvinen.com/2021/two-machine-virtual-network-with-debian-11-bullseye-and-vagrant/. Viitattu: 4.11.2024.
-  Karvinen, T. 2018. Salt Quickstart – Salt Stack Master and Slave on Ubuntu Linux. Luettavissa: https://terokarvinen.com/2018/salt-quickstart-salt-stack-master-and-slave-on-ubuntu-linux/?fromSearch=salt%20quickstart%20salt%20stack%20master%20and%20slave%20on%20ubuntu%20linux. Viitattu: 4.11.2024
-  Karvinen, T. 2014. Hello Salt Infra-as-Code. Luettavissa: https://terokarvinen.com/2024/hello-salt-infra-as-code/. Viitattu: 4.11.2024
-  Salt contributors 2021-2024. Salt overview. Luettavissa: https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#rules-of-yaml. Viitattu: 4.11.2024.
- Salt projektin blogi 2024. Luettavissa: https://saltproject.io/blog/salt-project-package-repo-migration-and-guidance/. Viitattu: 5.11.2024.
